import fs from "fs/promises";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const ROOT = path.resolve(__dirname, "..");

const SITE_ORIGIN = process.env.SITE_ORIGIN || "https://festival-planner.tschann.me";
const FESTIVAL = process.env.FESTIVAL || "tomorrowland";
const YEAR = process.env.YEAR || "2026";

const snapshotPath = path.join(ROOT, "data", FESTIVAL, YEAR, "snapshots", "latest.json");
const artistsPath = path.join(ROOT, "data", FESTIVAL, YEAR, "artists", "latest.json");

const snapshotRaw = await fs.readFile(snapshotPath, "utf-8");
const snapshot = JSON.parse(snapshotRaw);
const slots = Array.isArray(snapshot.slots) ? snapshot.slots : [];

let artistMeta = new Map();
try {
  const artistsRaw = await fs.readFile(artistsPath, "utf-8");
  const artistsData = JSON.parse(artistsRaw);
  if (Array.isArray(artistsData.artists)) {
    artistMeta = new Map(artistsData.artists.map(a => [String(a.artistId || ""), a]));
  }
} catch {
  artistMeta = new Map();
}

const weekends = new Map();
for (const slot of slots) {
  const weekend = String(slot.weekend || "").toUpperCase();
  if (!weekend) continue;
  if (!weekends.has(weekend)) weekends.set(weekend, new Map());
  const artists = weekends.get(weekend);

  const artistId = String(slot.artistId || "");
  if (!artistId) continue;
  if (!artists.has(artistId)) {
    const name = String(slot.artist || "Unknown artist");
    const normalized = String(slot.artistNormalized || "");
    const meta = artistMeta.get(artistId) || {};
    const genres = Array.isArray(meta.genres) ? meta.genres.map(g => String(g || "")).filter(Boolean) : [];
    artists.set(artistId, {
      id: artistId,
      name,
      normalized,
      slots: [],
      stages: new Set(),
      genres
    });
  }
  const entry = artists.get(artistId);
  entry.slots.push(slot);
  if (slot.stage) entry.stages.add(String(slot.stage));
}

function slugify(value) {
  const base = String(value || "")
    .replace(/[ß?]/g, "ss")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .replace(/&/g, " and ")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/-+/g, "-")
    .replace(/^-|-$/g, "");
  return base || "artist";
}

function escapeHtml(value) {
  return String(value || "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function buildArtistSlugMap(artists) {
  const baseById = new Map();
  const counts = new Map();
  for (const artist of artists.values()) {
    const base = slugify(artist.normalized || artist.name);
    baseById.set(artist.id, base);
    counts.set(base, (counts.get(base) || 0) + 1);
  }
  const out = new Map();
  for (const [id, base] of baseById.entries()) {
    const suffix = (counts.get(base) || 0) > 1 ? `-${id.slice(0, 6)}` : "";
    out.set(id, `${base}${suffix}`);
  }
  return out;
}

function renderArtistPage({ artist, weekend, slug }) {
  const weekendNum = weekend.slice(1);
  const weekendLower = weekend.toLowerCase();
  const title = `${artist.name} - Tomorrowland ${YEAR} (Weekend ${weekendNum}) | Festival Planner`;
  const description = `Offline planning for Tomorrowland ${YEAR} Weekend ${weekendNum}. No account, no tracking.`;
  const canonical = `${SITE_ORIGIN}/${FESTIVAL}/${YEAR}/${weekendLower}/artists/${slug}/`;
  const stages = Array.from(artist.stages).sort();
  const genres = Array.isArray(artist.genres) ? artist.genres : [];
  const plannerUrl = `/${FESTIVAL}/${YEAR}/${weekendLower}/?artist=${encodeURIComponent(slug)}`;

  return `<!doctype html>
<html lang="de">
<head>
  <!-- Generated by scripts/generate-artist-pages.mjs; do not edit. -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>${escapeHtml(title)}</title>
  <meta name="description" content="${escapeHtml(description)}">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="${escapeHtml(canonical)}">
</head>
<body>
  <main>
    <h1>${escapeHtml(artist.name)} &ndash; Tomorrowland ${YEAR} (Weekend ${weekendNum})</h1>
    <p>Offline planning, no account, no tracking. Ratings and favorites stay on your device.</p>
    ${stages.length ? `<p>Stages: ${escapeHtml(stages.join(", "))}</p>` : ""}
    ${genres.length ? `<p>Tags: ${escapeHtml(genres.join(", "))}</p>` : ""}
    <p><a href="${escapeHtml(plannerUrl)}">Open in Planner</a></p>
  </main>
</body>
</html>`;
}

function renderArtistIndexPage({ weekend, entries }) {
  const weekendNum = weekend.slice(1);
  const weekendLower = weekend.toLowerCase();
  const title = `Tomorrowland ${YEAR} Artists (Weekend ${weekendNum}) | Festival Planner`;
  const description = `Artist directory for Tomorrowland ${YEAR} Weekend ${weekendNum}. Privacy-first, no tracking.`;
  const canonical = `${SITE_ORIGIN}/${FESTIVAL}/${YEAR}/${weekendLower}/artists/`;
  const plannerUrl = `/${FESTIVAL}/${YEAR}/${weekendLower}/`;
  const list = entries.map((entry) => `      <li><a href="./${escapeHtml(entry.slug)}/">${escapeHtml(entry.name)}</a></li>`).join("\n");

  return `<!doctype html>
<html lang="de">
<head>
  <!-- Generated by scripts/generate-artist-pages.mjs; do not edit. -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>${escapeHtml(title)}</title>
  <meta name="description" content="${escapeHtml(description)}">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="${escapeHtml(canonical)}">
</head>
<body>
  <main>
    <h1>Tomorrowland ${YEAR} Artists &ndash; Weekend ${weekendNum}</h1>
    <p>Offline planning, no account, no tracking.</p>
    <p><a href="${escapeHtml(plannerUrl)}">Back to Planner</a></p>
    <ul>
${list}
    </ul>
  </main>
</body>
</html>`;
}

const baseUrls = [
  `${SITE_ORIGIN}/`,
  `${SITE_ORIGIN}/${FESTIVAL}/${YEAR}/w1/`,
  `${SITE_ORIGIN}/${FESTIVAL}/${YEAR}/w2/`,
  `${SITE_ORIGIN}/about/`,
  `${SITE_ORIGIN}/changelog/`,
  `${SITE_ORIGIN}/privacy/`,
  `${SITE_ORIGIN}/impressum/`
];

const sitemapUrls = new Set(baseUrls);

for (const [weekend, artists] of weekends.entries()) {
  const weekendLower = weekend.toLowerCase();
  const artistDir = path.join(ROOT, FESTIVAL, YEAR, weekendLower, "artists");
  await fs.mkdir(artistDir, { recursive: true });

  const slugMap = buildArtistSlugMap(artists);
  const entries = [];

  for (const artist of artists.values()) {
    const slug = slugMap.get(artist.id);
    if (!slug) continue;
    const html = renderArtistPage({ artist, weekend, slug });
    const targetDir = path.join(artistDir, slug);
    await fs.mkdir(targetDir, { recursive: true });
    await fs.writeFile(path.join(targetDir, "index.html"), html, "utf-8");
    entries.push({ name: artist.name, slug });
    sitemapUrls.add(`${SITE_ORIGIN}/${FESTIVAL}/${YEAR}/${weekendLower}/artists/${slug}/`);
  }

  entries.sort((a, b) => String(a.name).localeCompare(String(b.name)));
  const indexHtml = renderArtistIndexPage({ weekend, entries });
  await fs.writeFile(path.join(artistDir, "index.html"), indexHtml, "utf-8");
  sitemapUrls.add(`${SITE_ORIGIN}/${FESTIVAL}/${YEAR}/${weekendLower}/artists/`);
}

const sitemapEntries = [...sitemapUrls].map((loc) => `  <url>\n    <loc>${loc}</loc>\n  </url>`).join("\n");
const sitemapXml = `<?xml version="1.0" encoding="UTF-8"?>\n<urlset xmlns="https://www.sitemaps.org/schemas/sitemap/0.9">\n${sitemapEntries}\n</urlset>\n`;
await fs.writeFile(path.join(ROOT, "sitemap.xml"), sitemapXml, "utf-8");

console.log(`Generated artist pages for ${weekends.size} weekends.`);